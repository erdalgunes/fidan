name: AI-Powered PR Review

on:
  pull_request:
    types: [opened, reopened]  # Removed 'synchronize' to reduce noise
    # Skip draft PRs to save costs
    branches: [main, develop]
  issue_comment:
    types: [created]  # Allow manual triggering with /ai-review comment
  workflow_dispatch:  # Allow manual runs

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: |
      ${{ 
        (github.event_name == 'pull_request' && !github.event.pull_request.draft && !contains(github.event.pull_request.labels.*.name, 'skip-ai-review')) ||
        (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/ai-review')) ||
        (github.event_name == 'workflow_dispatch')
      }}
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Python and uv
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Install AI CLI Tools
        env:
          # Use Personal Access Token if available, fallback to GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Install private tavily and gpt5 packages from GitHub
          echo "Installing tavily and gpt5 CLI tools..."
          
          # Configure git credentials for private repository access
          if [ -n "${{ secrets.PERSONAL_GITHUB_TOKEN }}" ]; then
            echo "üîë Using Personal Access Token for private repository access"
          else
            echo "‚ö†Ô∏è Using GitHub Actions token (limited private repo access)"
            echo "üí° Add PERSONAL_GITHUB_TOKEN secret for full functionality"
          fi
          
          gh auth status
          echo "üîß Configuring git credentials for private repository access..."
          
          # Set up git credentials for private repository access
          git config --global credential.helper store  
          echo "https://${GH_TOKEN}@github.com" > ~/.git-credentials
          
          # Also configure git to use the token for authentication
          git config --global url."https://${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          # Test uvx access to private repositories
          echo "üß™ Testing uvx access to private AI tools..."
          
          # Test tavily access
          echo "Testing tavily..."
          if uvx --from git+https://github.com/erdalgunes/tavily-cli.git tavily --version; then
            echo "‚úÖ Tavily accessible via uvx"
            TAVILY_AVAILABLE=true
          else
            echo "‚ùå Tavily not accessible via uvx - trying with authentication"
            if uvx --from git+https://${GH_TOKEN}@github.com/erdalgunes/tavily-cli.git tavily --version; then
              echo "‚úÖ Tavily accessible via uvx with authentication"
              TAVILY_AVAILABLE=true
              TAVILY_AUTH_URL="git+https://${GH_TOKEN}@github.com/erdalgunes/tavily-cli.git"
            else
              echo "‚ùå Tavily not accessible even with authentication"
              TAVILY_AVAILABLE=false
            fi
          fi
          
          # Test gpt5 access  
          echo "Testing gpt5..."
          if uvx --from git+https://github.com/erdalgunes/gpt5-cli.git gpt5 --version; then
            echo "‚úÖ GPT-5 accessible via uvx"
            GPT5_AVAILABLE=true
          else
            echo "‚ùå GPT-5 not accessible via uvx - trying with authentication"
            if uvx --from git+https://${GH_TOKEN}@github.com/erdalgunes/gpt5-cli.git gpt5 --version; then
              echo "‚úÖ GPT-5 accessible via uvx with authentication"
              GPT5_AVAILABLE=true
              GPT5_AUTH_URL="git+https://${GH_TOKEN}@github.com/erdalgunes/gpt5-cli.git"
            else
              echo "‚ùå GPT-5 not accessible even with authentication"
              GPT5_AVAILABLE=false
            fi
          fi
          
          # Export variables for use in later steps
          echo "TAVILY_AVAILABLE=$TAVILY_AVAILABLE" >> $GITHUB_ENV
          echo "GPT5_AVAILABLE=$GPT5_AVAILABLE" >> $GITHUB_ENV
          echo "TAVILY_AUTH_URL=${TAVILY_AUTH_URL:-git+https://github.com/erdalgunes/tavily-cli.git}" >> $GITHUB_ENV
          echo "GPT5_AUTH_URL=${GPT5_AUTH_URL:-git+https://github.com/erdalgunes/gpt5-cli.git}" >> $GITHUB_ENV
          
          # Summary of tool availability
          echo "üìã AI Tool Status:"
          if [ "$TAVILY_AVAILABLE" = "true" ]; then
            echo "‚úÖ Tavily: Available via uvx"
          else
            echo "‚ùå Tavily: Not available"
          fi
          
          if [ "$GPT5_AVAILABLE" = "true" ]; then
            echo "‚úÖ GPT-5: Available via uvx"
          else
            echo "‚ùå GPT-5: Not available"
          fi
          
      - name: Get Changed Files
        id: changed-files
        run: |
          # Get list of changed files with their status
          git diff --name-status origin/${{ github.base_ref }}...${{ github.sha }} > changed_files.txt
          echo "Files changed:"
          cat changed_files.txt
          
          # Count changes for cost control
          TOTAL_CHANGES=$(git diff --numstat origin/${{ github.base_ref }}...${{ github.sha }} | awk '{ lines += $1 + $2 } END { print lines }')
          echo "total_changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
          
          # Skip review if changes are too large (cost control)
          if [ "$TOTAL_CHANGES" -gt 2000 ]; then
            echo "skip_review=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PR too large ($TOTAL_CHANGES lines) - skipping AI review for cost control"
          else
            echo "skip_review=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Research Dependencies and Security
        if: steps.changed-files.outputs.skip_review == 'false'
        id: tavily-research
        run: |
          echo "Researching security and best practices..."
          
          # Extract dependency changes
          DEPS_CHANGED=""
          if grep -q "build.gradle\|package.json\|requirements.txt\|Cargo.toml\|go.mod" changed_files.txt; then
            DEPS_CHANGED="Dependencies modified in this PR"
          fi
          
          # Extract file types for targeted research  
          FILE_TYPES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | sed 's/.*\.//' | sort -u | tr '\n' ' ')
          echo "file_types=$FILE_TYPES" >> $GITHUB_OUTPUT
          echo "deps_changed=$DEPS_CHANGED" >> $GITHUB_OUTPUT
          
          # Research security if dependencies changed
          if [ -n "$DEPS_CHANGED" ]; then
            echo "üîç Dependencies changed - will research security implications"
          fi
          
      - name: AI Code Analysis
        if: steps.changed-files.outputs.skip_review == 'false'
        id: ai-analysis
        run: |
          # Create a focused diff for analysis (limit size for cost control)
          git diff origin/${{ github.base_ref }}...${{ github.sha }} -- '*.kt' '*.java' '*.js' '*.ts' '*.py' '*.go' '*.rs' > code_diff.txt
          
          # Truncate if too large
          if [ $(wc -c < code_diff.txt) -gt 50000 ]; then
            head -c 50000 code_diff.txt > code_diff_truncated.txt
            mv code_diff_truncated.txt code_diff.txt
            echo "‚ö†Ô∏è Code diff truncated for analysis" >> analysis_notes.txt
          fi
          
          echo "üìä Code diff prepared for AI analysis ($(wc -c < code_diff.txt) chars)"
          
      - name: Generate AI Review
        if: steps.changed-files.outputs.skip_review == 'false'
        run: |
          cat > review_script.sh << 'EOF'
          #!/bin/bash
          
          echo "# ü§ñ AI-Powered Code Review"
          echo ""
          
          # Security research using Tavily (if available)
          if [ "$TAVILY_AVAILABLE" = "true" ] && [ -n "${{ steps.tavily-research.outputs.deps_changed }}" ]; then
            echo "## üîê Security Analysis"
            uvx --from $TAVILY_AUTH_URL tavily "security vulnerabilities ${{ steps.tavily-research.outputs.file_types }} dependencies 2024" --max-results 2 2>/dev/null || echo "‚ö†Ô∏è Security research failed"
            echo ""
          fi
          
          # Code analysis using GPT-5 (if available)  
          if [ "$GPT5_AVAILABLE" = "true" ]; then
            echo "## üìù Code Analysis"
            
            # Create analysis prompt
            ANALYSIS_PROMPT="Analyze this code diff for a ${{ github.event.repository.name }} project:

          $(head -c 30000 code_diff.txt 2>/dev/null || echo "No code diff available")

          Focus on:
          1. üêõ Potential bugs or issues
          2. üîí Security concerns  
          3. ‚ö° Performance implications
          4. üßπ Code quality improvements
          5. üèóÔ∏è Architecture feedback

          Provide specific, actionable feedback with emojis. If no issues found, say so briefly."

            # Run analysis with cost control using uvx
            echo "$ANALYSIS_PROMPT" | uvx --from $GPT5_AUTH_URL gpt5 --effort medium --max-tokens 1000 2>/dev/null || echo "‚ö†Ô∏è Code analysis failed"
          else
            echo "## üìù Code Analysis"
            echo "‚ö†Ô∏è GPT-5 not available via uvx"
            if [ "$TAVILY_AVAILABLE" = "true" ]; then
              echo "üîç Using Tavily for alternative analysis..."
              uvx --from $TAVILY_AUTH_URL tavily "code review ${{ github.event.repository.name }} ${{ steps.tavily-research.outputs.file_types }} best practices" --max-results 3 2>/dev/null || echo "‚ö†Ô∏è Alternative analysis failed"
            fi
          fi
          
          echo ""
          echo "## üìã Review Summary"
          echo "- **Changed files**: $(wc -l < changed_files.txt)"
          echo "- **Total changes**: ${{ steps.changed-files.outputs.total_changes }} lines"
          echo "- **File types**: ${{ steps.tavily-research.outputs.file_types }}"
          echo "- **Dependencies**: ${{ steps.tavily-research.outputs.deps_changed || 'No dependency changes detected' }}"
          
          echo ""
          echo "---"
          echo "*ü§ñ Generated by AI PR Review Bot | [Feedback](https://github.com/${{ github.repository }}/issues)*"
          EOF
          
          chmod +x review_script.sh
          ./review_script.sh > ai_review.md
          
      - name: Post AI Review Comment
        if: steps.changed-files.outputs.skip_review == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the AI review
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync('ai_review.md', 'utf8');
            } catch (error) {
              reviewContent = '## ü§ñ AI Review\n\n‚ö†Ô∏è Review generation failed. Please check the logs.';
            }
            
            // Check if we already commented on this PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.body.includes('ü§ñ Generated by AI PR Review Bot')
            );
            
            if (botComment) {
              // Only update if content has meaningfully changed (avoid noise)
              const existingContent = botComment.body;
              const existingFileCount = existingContent.match(/\*\*Changed files\*\*: (\d+)/)?.[1];
              const newFileCount = reviewContent.match(/\*\*Changed files\*\*: (\d+)/)?.[1];
              
              if (existingFileCount !== newFileCount || !existingContent.includes('ü§ñ Generated by AI PR Review Bot')) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: reviewContent
                });
                console.log('Updated existing AI review comment');
              } else {
                console.log('Skipped update - no meaningful changes detected');
              }
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reviewContent
              });
              console.log('Created new AI review comment');
            }
            
      - name: Handle Large PR
        if: steps.changed-files.outputs.skip_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const reviewContent = `## ü§ñ AI Review - PR Too Large
            
            This PR has ${{ steps.changed-files.outputs.total_changes }} lines of changes, which exceeds our analysis limit of 2000 lines.
            
            **Recommendations:**
            - Consider splitting this PR into smaller, focused changes
            - Each PR should ideally be < 500 lines for better reviewability
            - Use our [PR size guidelines](.github/pr-scope-guidelines.md) for reference
            
            *ü§ñ AI review will be available once the PR size is reduced*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewContent
            });